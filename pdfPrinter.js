
url = 'http://127.0.0.1:8080/get_pdf?payload=%7B%22pdf_url%22%3A%22https%3A%2F%2Fseller.shopee.tw%2Fapi%2Fv3%2Flogistics%2Fdownload_sd_job%3Fjob_id%3DSDK0001_8e2b71be186c1d4bc0d0ebb37a75e640%22%2C%22cookie%22%3A%22SPC_SC_SA_TK%3D%3BSPC_SC_SA_UD%3D%3B_gcl_au%3D1.1.1705790090.1701080060%3Bfulfillment-language%3Dzh-Hant%3BREC_T_ID%3D784e3363-9b96-11ed-a792-f4ee0829040a%3BSC_DFP%3DEBrSFkxHXSNChDGjeSmEzXoDsOcNtFqF%3BSPC_CDS%3Da165db25-318b-4ee4-b8c7-7ba8031e173b%3BSPC_CLIENTID%3DeTlFcUZBcXYxUEE3ykjudzgfjhkikahz%3BSPC_F%3Dy9EqFAqv1PA7XQUY3RyMT53ywzXws5C1%3BSPC_SC_TK%3D04063eb419cd455388408512ddd63aa8%3BSPC_SC_UD%3D910574341%3BSPC_SI%3DvTi2ZAAAAABhM0g5U0hSMYW%2F1gEAAAAAWnZBYXU1Zjk%3D%3BSPC_ST%3D.NlVOUTVXcll0TjBPeEVzcnBjWJiTkOU5oXZHwKJz9GjQ6MqmBsSkedjbqvAJ9qgd2kzNt6L0Bnnibw2PIvrZfTJhaCPfpMZ9bAXrYaW2qG49x4%2FHV6cgYMo1TOv88D%2FK4CJND7WOpVKARkwCONekjU2SNCfDU48RHDqt0lxBnyk8oIVmVxCqqHuDW0FkivXqY3Bb%2F85Y7XF4lvmv3EUTiKQp5E0ikAL1oErJAtqVHlk%3D%3BSPC_STK%3Dc6pWn9CzQjRpBFyE%2FBqXQjaYMKAc05ysHcA5wBknrsKPW0nAM15v1QoK%2BnkKTZoa3frdaJv6Cms9dcCwVtS79X0SFAkvdpnqvcOiMn9unSAG7mwvCLHMbOZNaDcrcdGaHrfnBklWLIUbmg78Dq1lV6KrNuckA8WYYmHf6PsAPrw2%2FoOWH%2FO8yQwuwqsfrbg6%3BSPC_U%3D910574341%3B_fbp%3Dfb.1.1674530607974.226570713%3BSPC_R_T_IV%3DdXMyVkkxVVl6Tncza1VXbw%3D%3D%3BSPC_T_ID%3DylPRie0P%2FMUyRErR0mkcovCeLuU5vGyCgd7yu4ryTLE0H7lFnnwR8w9pq9fqqTcaZGEED9G7cBVBgA%2BXuHmgqKw1h%2FVa1K723Xk9MQJzAMEYszLQbnfCX0cLcMcruyElTKwUYw2fiR5rHCSKseBGWLzou81OB4jgvwHZugwD4XU%3D%3BSPC_T_IV%3DdXMyVkkxVVl6Tncza1VXbw%3D%3D%3BSPC_R_T_ID%3DylPRie0P%2FMUyRErR0mkcovCeLuU5vGyCgd7yu4ryTLE0H7lFnnwR8w9pq9fqqTcaZGEED9G7cBVBgA%2BXuHmgqKw1h%2FVa1K723Xk9MQJzAMEYszLQbnfCX0cLcMcruyElTKwUYw2fiR5rHCSKseBGWLzou81OB4jgvwHZugwD4XU%3D%3B_QPWSDCXHZQA%3D3959b7bf-140c-48de-e409-cfdc191eb938%3B_ga_E1H7XE0312%3DGS1.1.1701405189.6.0.1701405189.0.0.0%3B_ga%3DGA1.2.1370422224.1674530613%3BSPC_EC%3DVjltdWMyNlVOUm5YdE9VMpgkK4Re5hzHldC71MQitbPwmsP5idydBnfSij3vxrnGgv325P4z8eI9KWIeMvRayD1rnmUJIV2vw%2FA1p4kXri0XCxuvNv1bzlqTCHzlDLISI2nv7ceXcjAtcJ3W45otgWYdlimlJ9O2wRLAt%2BfXfxv%2FgkKteeGCQQYK2o8B9UZT%3BREC7iLP4Q%3Dda898f73-8736-4c93-8f37-7fbcd476cbbc%3BSPC_SEC_SI%3Dv1-bHExVUtxV29mMTdjSHlXZ8FcMB5tK%2F8Tqw5eAUW5FkqjjoIE3fvXZ2cQ2HUYWZ7SP3%2BUZIWsp77JWfdqOzX8Nfc3YzGKaT3cOUzRmuHwMJU%3D%3BCTOKEN%3DWo7iupE4Ee6zaqq%252BVGgKRA%253D%253D%3Bshopee_webUnique_ccd%3DOCvbzM977C2lVq2maDvWBg%253D%253D%257Cnit4JH9V5l3Xjz7B%252B7vA2kKoKtCryJE%252F3gy4BJYHf26tVPyQVyr1zAj%252FmUezagDi2dJCbtbESq5noQ%253D%253D%257Cc91Hwyi%252Fpm4ck7yK%257C08%257C3%3Bds%3Dfce37e2d3217c61ca38c935e3dc38377%3B%22%2C%22crop%22%3A%7B%22x%22%3A0%2C%22y%22%3A0%2C%22width%22%3A0.5%2C%22height%22%3A0.5%7D%7D';
url = window.location.href;

// 抓取 payload 的值
var payload = url.split('payload=')[1];
payload = decodeURIComponent(payload);
payload = JSON.parse(payload);
var pdfUrl = payload.pdf_url;
var crop = payload.crop;

// 如果 crop 不存在，則設定預設值
if (crop == null) {
    crop = {
        x: 0,
        y: 0,
        width: 1,
        height: 1,
    };
}

var pdfDoc = null;

function renderPage (num) {

    
    pdfDoc.getPage(num).then (function (page) {
        var viewport = page.getViewport ({ scale: 4 });
        var canvas = document.querySelector ('canvas') ;
        var ctx = canvas.getContext ('2d') ;
        canvas.height = viewport.height * crop.height;
        canvas.width = viewport.width * crop.width;
        viewport = page.getViewport ({ scale: 4, offsetX: viewport.width * crop.x, offsetY: viewport.height * crop.y });

        
        var renderContext = {
            canvasContext: ctx,
            viewport: viewport
        };
        var pageRendering = page.render(renderContext);
        pageRendering.promise.finally(function () {
            setTimeout(function () {
                window.print();
                window.close();
            }, 1000);
        });


    });
}

pdfjsLib.getDocument(pdfUrl).promise.then(function (pdf) {
    pdfDoc = pdf;
    renderPage(1)
});
